# =============================================================================
# SubtitleRAG - Kubernetes Deployment
# =============================================================================

apiVersion: apps/v1
kind: Deployment
metadata:
  name: subtitle-rag
  labels:
    app: subtitle-rag
    version: v1
spec:
  replicas: 1
  selector:
    matchLabels:
      app: subtitle-rag
  template:
    metadata:
      labels:
        app: subtitle-rag
        version: v1
    spec:
      # =================================================================
      # INIT CONTAINER - Validates ChromaDB data before app starts
      # =================================================================
      initContainers:
        - name: validate-chroma-data
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              echo "=========================================="
              echo "SubtitleRAG - Data Validation"
              echo "=========================================="
              if [ ! -d "/data/subtitle_project_chroma_db_" ]; then
                echo "ERROR: ChromaDB directory not found!"
                echo "Expected: /data/subtitle_project_chroma_db_"
                exit 1
              fi
              if [ ! -f "/data/subtitle_project_chroma_db_/chroma.sqlite3" ]; then
                echo "ERROR: ChromaDB SQLite database not found!"
                exit 1
              fi
              echo "ChromaDB directory found"
              echo "SQLite database found"
              echo "Data validation successful"
              echo "=========================================="
          volumeMounts:
            - name: chroma-data
              mountPath: /data
              readOnly: true

      # =================================================================
      # MAIN APPLICATION CONTAINER
      # =================================================================
      containers:
        - name: subtitle-rag-api
          image: subtitlerag:latest
          imagePullPolicy: Never

          # ----------------------------------------------------------------
          # Use Uvicorn entrypoint and enable lifespan
          command:
            - uvicorn
          args:
            - src.api.main:app
            - --host
            - 0.0.0.0
            - --port
            - "8000"
            - --lifespan
            - "on"
          # ----------------------------------------------------------------

          ports:
            - name: http
              containerPort: 8000
              protocol: TCP

          envFrom:
            - configMapRef:
                name: subtitle-rag-config

          env:
            - name: LANGCHAIN_API_KEY
              valueFrom:
                secretKeyRef:
                  name: subtitle-rag-secrets
                  key: langchain-api-key
                  optional: true

          resources:
            requests:
              memory: "4Gi"
              cpu: "1000m"
            limits:
              memory: "6Gi"
              cpu: "2000m"

          volumeMounts:
            - name: chroma-data
              mountPath: /app/chroma_data
              readOnly: false

          livenessProbe:
            httpGet:
              path: /api/v1/live
              port: 8000
            initialDelaySeconds: 60
            periodSeconds: 15
            timeoutSeconds: 30
            failureThreshold: 3

          readinessProbe:
            httpGet:
              path: /api/v1/health
              port: 8000
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 30
            failureThreshold: 3

          startupProbe:
            httpGet:
              path: /api/v1/health
              port: 8000
            initialDelaySeconds: 30
            periodSeconds: 15
            timeoutSeconds: 30
            failureThreshold: 60

      # =================================================================
      # VOLUMES
      # =================================================================
      volumes:
        - name: chroma-data
          persistentVolumeClaim:
            claimName: subtitle-rag-pvc

      terminationGracePeriodSeconds: 30